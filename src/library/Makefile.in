CFLAGS   = -fPIC -O2 -I$(SRCDIR) $(CONSTANTS) $(PAPI_CFLAGS)
LDFLAGS  = -shared  $(PAPI_LDFLAGS) $(CPUF_LDFLAGS)

######## VARS

export DIR
export CFLAGS
export LDFLAGS

######## FILES

METRICS_OBJS = $(SRCDIR)/metrics/custom/hardware_info.o \
               $(SRCDIR)/metrics/papi/generics.o \
               $(SRCDIR)/metrics/papi/cache.o \
               $(SRCDIR)/metrics/papi/flops.o \
               $(SRCDIR)/metrics/papi/instructions.o \
               $(SRCDIR)/metrics/papi/stalls.o \
               $(SRCDIR)/control/frequency.o

COMMON_OBJS = $(SRCDIR)/common/shared_configuration.o \
              $(SRCDIR)/common/ear_daemon_client.o \
              $(SRCDIR)/common/environment_common.o \
              $(SRCDIR)/common/file_lock.o \
              $(SRCDIR)/common/environment.o 

TYPES = $(SRCDIR)/common/types.a

TRACE_OBJS = states/states.o \
             tracer/tracer.o \
             mpi_intercept/ear_api.o 

OBJS = dynais/dynais.o \
       tracer/tracer.o \
       states/states.o \
       metrics/metrics.o \
       models/models.o \
       models/min_time.o \
       models/min_energy.o \
       models/monitoring.o \
       models/sig_projections.o

MPI_OBJS = mpi_intercept/process_MPI.o   \
           mpi_intercept/MPI_intercept.o \
           mpi_intercept/MPI_interface.o \
           mpi_intercept/ear_api.o

ALL_OBJS = $(OBJS) $(COMMON_OBJS) $(METRICS_OBJS) $(TYPES)

######## RULES

all: @mpi_so@ @ompi_so@

%.o: %.c
	@ $(MAKE) -C `dirname $@` `basename $@` || exit

@mpi_so@: $(ALL_OBJS)
	$(CC) $(CC_FLAGS) $(CFLAGS) -o @mpi_so@ $(LDFLAGS) $(ALL_OBS)

@ompi_so@: $(ALL_OBS)
	$(CC) $(CC_FLAGS) $(CFLAGS) -o @ompi_so@ $(LDFLAGS) $(ALL_OBJS)

######## OPTIONS

install:
	mv libear.so $(DESTDIR)/lib/libear.so
	mv libeart.so $(DESTDIR)/lib/libeart.so

clean:
	rm -f *.so *.a *.o $(BINARIES) $(OBJS)
