CFLAGS   = -fPIC -O2 -I$(SRCDIR) $(CONSTANTS) $(PAPI_CFLAGS)
LDFLAGS  = -shared $(PAPI_LDFLAGS) $(CPUF_LDFLAGS)

######## FILES

METRICS_OBJS = $(SRCDIR)/metrics/custom/hardware_info.o \
               $(SRCDIR)/metrics/papi/generics.o \
               $(SRCDIR)/metrics/papi/cache.o \
               $(SRCDIR)/metrics/papi/flops.o \
               $(SRCDIR)/metrics/papi/instructions.o \
               $(SRCDIR)/metrics/papi/stalls.o \
               $(SRCDIR)/control/frequency.o

COMMON_OBJS = $(SRCDIR)/daemon/eard_client_api.o \
              $(SRCDIR)/common/environment_common.o \
              $(SRCDIR)/common/file_lock.o \
              $(SRCDIR)/common/environment.o \
              $(SRCDIR)/common/math_operations.o \
              $(SRCDIR)/common/types.a \
              $(SRCDIR)/daemon/shared_configuration.o

OUTER_OBJS = $(COMMON_OBJS) $(METRICS_OBJS)

REMAKE_OBJS = states/states.o \
			  states/states_periodic.o \
              tracer/tracer.o \
              mpi_intercept/ear_api.o \
              mpi_intercept/process_MPI.o \
              mpi_intercept/MPI_intercept.o \
              mpi_intercept/MPI_interface.o

OBJS = dynais/dynais.o \
       metrics/metrics.o \
       models/models.o \
       models/min_time.o \
       models/min_energy.o \
       models/monitoring.o \
       models/sig_projections.o 

######## VARS

export DIR
export CFLAGS
export LDFLAGS

######## RULES

all: all.gnrc.components
     all.impi.components libear.so \
     all.ompi.components libear_ompi.so

%.so:
	$(CC) $(CC_FLAGS) $(CFLAGS) -o $@ $(LDFLAGS) $(REMAKE_OBJS) $(OBJS) $(OUTER_OBJS)

######## OPTIONS

install:

clean:
	rm -f *.o *.a *.so

######## SUBFOLDERS

%.gnrc.components:
	$(MAKE) -C 'dynais' $*
	$(MAKE) -C 'metrics' $*
	$(MAKE) -C 'models' $*

%.impi.components:
	$(MAKE) -B 'mpi_intercept' $* MPICC='$(MPICC)'
	$(MAKE) -B 'states' $* MPICC='$(MPICC)'
	$(MAKE) -B 'tracer' $* MPICC='$(MPICC)'

%.ompi.components:
	$(MAKE) -B 'mpi_intercept' $* MPICC='$(OMPICC)'
	$(MAKE) -B 'states' $* MPICC='$(OMPICC)'
	$(MAKE) -B 'tracer' $* MPICC='$(OMPICC)'